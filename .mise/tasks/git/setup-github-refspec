#!/usr/bin/env bash
#MISE description="Add git refspec to fetch GitHub PR refs from a GitHub remote"

#USAGE arg "remote"                     help="The name of the git remote to configure for GitHub PR refs"

set -Eeuo pipefail

REMOTE="${usage_remote}"

source .mise/tasks/console/ansi-colors

# Get the remote URL.
remote_url=$(git remote get-url "${REMOTE}" 2>/dev/null || true)
if [ -z "$remote_url" ]; then
    echo "${ANSI_BRIGHT_YELLOW}${ANSI_BOLD}Warning:${ANSI_NORMAL} Remote ${ANSI_BRIGHT_RED}${ANSI_BOLD}${REMOTE}${ANSI_NORMAL} does not exist in the configured remotes."
    exit 0
fi

# Check if the remote URL directly indicates a GitHub remote
is_github=false
if echo "$remote_url" | grep -qi 'github\.'; then
    is_github=true
else
    # Extract the host part from SSH URLs like "Host:path" or "git@Host:path"
    if [[ "$remote_url" =~ ^([^@]+@)?([^:]+): ]]; then
        host_alias="${BASH_REMATCH[2]}"

        # Use ssh -G to get the resolved hostname for the alias
        if command -v ssh >/dev/null 2>&1; then
            resolved_hostname=$(ssh -G "$host_alias" 2>/dev/null | grep "^hostname " | awk '{print $2}')

            # Check if the resolved hostname is github.com
            if [[ -n "$resolved_hostname" ]] && [[ "$resolved_hostname" == *"github.com"* ]]; then
                is_github=true
            fi
        fi
    fi
fi

if [ "$is_github" = false ]; then
    echo "${ANSI_BRIGHT_YELLOW}${ANSI_BOLD}Warning:${ANSI_NORMAL} Remote ${ANSI_BRIGHT_RED}${ANSI_BOLD}${REMOTE}${ANSI_NORMAL} exists, but is not a GitHub URL (found: ${remote_url})."
    exit 0
fi

expected_refspec_head="+refs/pull/*/head:refs/remotes/${REMOTE}/pr/*"
expected_refspec_merge="+refs/pull/*/merge:refs/remotes/${REMOTE}/pr/merge/*"

# Get current fetch refspecs.
current_fetches=$(git config --get-all remote.${REMOTE}.fetch || true)

# Check if both expected refspecs are already configured.
if echo "$current_fetches" | grep -Fq "${expected_refspec_head}" && echo "$current_fetches" | grep -Fq "${expected_refspec_merge}"; then
    echo "${ANSI_BRIGHT_YELLOW}${ANSI_BOLD}Warning:${ANSI_NORMAL} Refspecs for remote ${ANSI_BRIGHT_RED}${ANSI_BOLD}${REMOTE}${ANSI_NORMAL} are already configured."
    exit 0
fi

# Add head refspec if missing.
if ! echo "$current_fetches" | grep -Fq "${expected_refspec_head}"; then
    mise run console:run "git config --add remote.${ANSI_BRIGHT_RED}${ANSI_BOLD}${REMOTE}${ANSI_NORMAL}.fetch '${expected_refspec_head}'"
fi

# Add merge refspec if missing.
if ! echo "$current_fetches" | grep -Fq "${expected_refspec_merge}"; then
    mise run console:run "git config --add remote.${ANSI_BRIGHT_RED}${ANSI_BOLD}${REMOTE}${ANSI_NORMAL}.fetch '${expected_refspec_merge}'"
fi
